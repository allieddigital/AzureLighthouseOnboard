{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.25.53.49325",
      "templateHash": "13555740326958332942"
    }
  },
  "parameters": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Specify the name of the resource group where the SOC is permitted to deploy and manage playbooks and supporting Logic Apps"
      }
    },
    "customerAzureSecurityInsightsId": {
      "type": "string",
      "metadata": {
        "description": "We need your Azure Security Insights Enterprise Application Object ID to enable runbook access and restrictions prevent us from discovering this automatically for you. To find it, go to https://portal.azure.com/#view/Microsoft_AAD_IAM/StartboardApplicationsMenuBlade/~/AppAppsPreview, remove the \"Application Type == Enterprise Applications\" filter, and then type \"Azure Security Insights\" into the filter box, and copy the Object ID (Not the Application ID) here. You can also run the following Azure PowerShell command: (Get-AzADServicePrincipal -Filter \"DisplayName eq 'Azure Security Insights'\").Id "
      }
    }
  },
  "variables": {
    "mspOfferName": "Security Operations Center - Azure Sentinel Playbook Management",
    "mspOfferDescription": "Enables Allied Digital SOC operations to deploy and manage playbooks within a resource group",
    "managedByTenantId": "2f46c040-48e3-4eb8-8fbf-418417f64401",
    "managedBySecurityInsightsAppId": "53769958-144f-4a47-9e8e-8dbc823fb622",
    "groupMap": {
      "L1SocOperators": "a2b7313e-013c-4242-bfa5-bee22442a262",
      "L2SocOperators": "b933b7fa-b3b5-47d8-a0cb-1b92b952d0eb"
    },
    "roleMap": {
      "Contributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
      "MicrosoftSentinelAutomationContributor": "f4c81013-99ee-4d62-a7ee-b3f1f648599a"
    },
    "authorizations": [
      {
        "principalId": "[variables('groupMap').L2SocOperators]",
        "principalIdDisplayName": "SOC Level 2 Operators",
        "roleDefinitionId": "[variables('roleMap').Contributor]"
      },
      {
        "principalId": "[variables('managedBySecurityInsightsAppId')]",
        "roleDefinitionId": "[variables('roleMap').MicrosoftSentinelAutomationContributor]",
        "principalIdDisplayName": "Managed Service Provider Azure Security Insights App"
      }
    ]
  },
  "resources": [
    {
      "type": "Microsoft.ManagedServices/registrationDefinitions",
      "apiVersion": "2022-10-01",
      "name": "[guid(variables('mspOfferName'))]",
      "properties": {
        "registrationDefinitionName": "[variables('mspOfferName')]",
        "description": "[variables('mspOfferDescription')]",
        "managedByTenantId": "[variables('managedByTenantId')]",
        "authorizations": "[variables('authorizations')]"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "SOC_Playbook_Management_Access",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "mspRegistrationId": {
            "value": "[subscriptionResourceId('Microsoft.ManagedServices/registrationDefinitions', guid(variables('mspOfferName')))]"
          },
          "customerAzureSecurityInsightsId": {
            "value": "[parameters('customerAzureSecurityInsightsId')]"
          },
          "MicrosoftSentinelAutomationContributorRoleId": {
            "value": "[variables('roleMap').MicrosoftSentinelAutomationContributor]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.25.53.49325",
              "templateHash": "12345770267123189842"
            }
          },
          "parameters": {
            "mspRegistrationId": {
              "type": "string",
              "metadata": {
                "description": "The registration ID to assign"
              }
            },
            "customerAzureSecurityInsightsId": {
              "type": "string",
              "metadata": {
                "description": "The customer Azure Security Insights ID required for multi-tenant playbook automation."
              }
            },
            "MicrosoftSentinelAutomationContributorRoleId": {
              "type": "string",
              "defaultValue": "f4c81013-99ee-4d62-a7ee-b3f1f648599a",
              "metadata": {
                "description": "The role used for Microsoft Sentinel Automation Contributor. This is usually a fixed value"
              }
            }
          },
          "variables": {
            "assignmentId": "[guid(parameters('mspRegistrationId'), resourceGroup().id)]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedServices/registrationAssignments",
              "apiVersion": "2022-10-01",
              "name": "[variables('assignmentId')]",
              "properties": {
                "registrationDefinitionId": "[parameters('mspRegistrationId')]"
              }
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(parameters('customerAzureSecurityInsightsId'), parameters('MicrosoftSentinelAutomationContributorRoleId'))]",
              "properties": {
                "principalId": "[parameters('customerAzureSecurityInsightsId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('MicrosoftSentinelAutomationContributorRoleId'))]",
                "principalType": "ServicePrincipal"
              }
            }
          ],
          "outputs": {
            "assignment": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.ManagedServices/registrationAssignments', variables('assignmentId')), '2022-10-01', 'full')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.ManagedServices/registrationDefinitions', guid(variables('mspOfferName')))]"
      ]
    }
  ],
  "outputs": {
    "mspOfferName": {
      "type": "string",
      "value": "[format('Managed by {0}', variables('mspOfferName'))]"
    },
    "authorizations": {
      "type": "array",
      "value": "[variables('authorizations')]"
    }
  }
}