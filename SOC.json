{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.29.47.4906",
      "templateHash": "4211995421493097095"
    }
  },
  "parameters": {
    "ResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Specify the name of the resource group where the SOC is permitted to deploy Sentinel supporting solutions. This is typically the same resource group as the Sentinel workspace but you may also opt for a separate resource group. If left empty, the SOC solution setup will be skipped"
      }
    }
  },
  "variables": {
    "mspOfferName": "Security Operations Center - Azure Sentinel Management",
    "mspOfferDescription": "Enables SOC operations to manage and monitor your Azure Sentinel environment",
    "managedByTenantId": "2f46c040-48e3-4eb8-8fbf-418417f64401",
    "managedByTenantSecurityInsightsObjectId": "53769958-144f-4a47-9e8e-8dbc823fb622",
    "groupMap": {
      "L1SocOperators": "a2b7313e-013c-4242-bfa5-bee22442a262",
      "L2SocOperators": "b933b7fa-b3b5-47d8-a0cb-1b92b952d0eb"
    },
    "roleMap": {
      "MicrosoftSentinelReader": "8d289c81-5878-46d4-8554-54e1e3d8b5cb",
      "MicrosoftSentinelResponder": "3e150937-b8fe-4cfb-8069-0eaf05ecd056",
      "MicrosoftSentinelContributor": "ab8e14d6-4a74-4a29-9ba8-549422addade",
      "MicrosoftSentinelPlaybookOperator": "51d6186e-6489-4900-b93f-92e23144cca5",
      "SecurityReader": "39bc4728-0917-49c7-9d2c-d95423bc2eb4",
      "SupportRequestContributor": "cfd33db0-3dd1-45e3-aa9d-cdbdf3b6f24e",
      "MonitoringContributor": "749f88d5-cbae-40b8-bcfc-e573ddc772fa",
      "ManagedServicesRegistrationAssignmentDeleteRole": "91c1777a-f3dc-4fae-b103-61d183457e46"
    },
    "authorizations": [
      {
        "principalId": "[variables('groupMap').L1SocOperators]",
        "principalIdDisplayName": "SOC Level 1 Operators",
        "roleDefinitionId": "[variables('roleMap').SecurityReader]"
      },
      {
        "principalId": "[variables('groupMap').L1SocOperators]",
        "principalIdDisplayName": "SOC Level 1 Operators",
        "roleDefinitionId": "[variables('roleMap').MicrosoftSentinelReader]"
      },
      {
        "principalId": "[variables('groupMap').L1SocOperators]",
        "principalIdDisplayName": "SOC Level 1 Operators",
        "roleDefinitionId": "[variables('roleMap').MicrosoftSentinelResponder]"
      },
      {
        "principalId": "[variables('groupMap').L1SocOperators]",
        "principalIdDisplayName": "SOC Level 1 Operators",
        "roleDefinitionId": "[variables('roleMap').SupportRequestContributor]"
      },
      {
        "principalId": "[variables('groupMap').L1SocOperators]",
        "principalIdDisplayName": "SOC Level 1 Operators",
        "roleDefinitionId": "[variables('roleMap').MicrosoftSentinelPlaybookOperator]"
      },
      {
        "principalId": "[variables('groupMap').L2SocOperators]",
        "principalIdDisplayName": "SOC Level 2 Operators",
        "roleDefinitionId": "[variables('roleMap').MonitoringContributor]"
      },
      {
        "principalId": "[variables('groupMap').L2SocOperators]",
        "principalIdDisplayName": "SOC Level 2 Operators",
        "roleDefinitionId": "[variables('roleMap').MicrosoftSentinelContributor]"
      },
      {
        "principalId": "[variables('groupMap').L2SocOperators]",
        "principalIdDisplayName": "SOC Level 2 Operators",
        "roleDefinitionId": "[variables('roleMap').ManagedServicesRegistrationAssignmentDeleteRole]"
      }
    ]
  },
  "resources": [
    {
      "type": "Microsoft.ManagedServices/registrationDefinitions",
      "apiVersion": "2022-10-01",
      "name": "[guid(format('{0}{1}', variables('mspOfferName'), variables('managedByTenantId')))]",
      "properties": {
        "registrationDefinitionName": "[variables('mspOfferName')]",
        "description": "[variables('mspOfferDescription')]",
        "managedByTenantId": "[variables('managedByTenantId')]",
        "authorizations": "[variables('authorizations')]"
      }
    },
    {
      "type": "Microsoft.ManagedServices/registrationAssignments",
      "apiVersion": "2022-10-01",
      "name": "[guid(format('{0}{1}', variables('mspOfferName'), variables('managedByTenantId')))]",
      "properties": {
        "registrationDefinitionId": "[subscriptionResourceId('Microsoft.ManagedServices/registrationDefinitions', guid(format('{0}{1}', variables('mspOfferName'), variables('managedByTenantId'))))]"
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.ManagedServices/registrationDefinitions', guid(format('{0}{1}', variables('mspOfferName'), variables('managedByTenantId'))))]"
      ]
    },
    {
      "condition": "[not(equals(parameters('ResourceGroupName'), ''))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-Solutions', deployment().name)]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "managedByTenantId": {
            "value": "[variables('managedByTenantId')]"
          },
          "managedByTenantSecurityInsightsObjectId": {
            "value": "[variables('managedByTenantSecurityInsightsObjectId')]"
          },
          "socManagementGroupId": {
            "value": "[variables('groupMap').L2SocOperators]"
          },
          "resourceGroupName": {
            "value": "[parameters('ResourceGroupName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "17531515696573586566"
            }
          },
          "parameters": {
            "managedByTenantId": {
              "type": "string"
            },
            "resourceGroupName": {
              "type": "string"
            },
            "socManagementGroupId": {
              "type": "string",
              "metadata": {
                "description": "The group that performs management of the RG"
              }
            },
            "managedByTenantSecurityInsightsObjectId": {
              "type": "string",
              "metadata": {
                "description": "The customer Azure Security Insights ID required for multi-tenant playbook automation."
              }
            }
          },
          "variables": {
            "mspOfferName": "Security Operations Center - Azure Sentinel Management - Solutions",
            "mspOfferDescription": "Enables SOC operations to deploy solutions to a particular resource group",
            "roleMap": {
              "Contributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
              "MicrosoftSentinelAutomationContributor": "f4c81013-99ee-4d62-a7ee-b3f1f648599a",
              "UserAccessAdministrator": "18d7d88d-d35e-4fb5-a5c3-7773c20a72d9",
              "MonitoringMetricsPublisher": "3913510d-42f4-4e42-8a64-420c390055eb",
              "StorageAccountContributor": "17d1049b-9a84-46fb-8f53-869881c3d3ab",
              "StorageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
              "StorageBlobDataOwner": "b7e6dc6d-f1e8-4753-8033-0f276bb0955b"
            },
            "authorizations": [
              {
                "principalId": "[parameters('socManagementGroupId')]",
                "principalIdDisplayName": "SOC Level 2 Operators",
                "roleDefinitionId": "[variables('roleMap').Contributor]"
              },
              {
                "principalId": "[parameters('socManagementGroupId')]",
                "principalIdDisplayName": "SOC Level 2 Operators",
                "roleDefinitionId": "[variables('roleMap').UserAccessAdministrator]",
                "delegatedRoleDefinitionIds": [
                  "[variables('roleMap').Contributor]",
                  "[variables('roleMap').MonitoringMetricsPublisher]",
                  "[variables('roleMap').StorageAccountContributor]",
                  "[variables('roleMap').StorageBlobDataContributor]",
                  "[variables('roleMap').StorageBlobDataOwner]"
                ]
              },
              {
                "principalId": "[parameters('managedByTenantSecurityInsightsObjectId')]",
                "roleDefinitionId": "[variables('roleMap').MicrosoftSentinelAutomationContributor]",
                "principalIdDisplayName": "Managed Service Provider Azure Security Insights App"
              }
            ]
          },
          "resources": [
            {
              "type": "Microsoft.ManagedServices/registrationDefinitions",
              "apiVersion": "2022-10-01",
              "name": "[guid(format('{0}{1}{2}', variables('mspOfferName'), parameters('managedByTenantId'), parameters('resourceGroupName')))]",
              "properties": {
                "registrationDefinitionName": "[variables('mspOfferName')]",
                "description": "[variables('mspOfferDescription')]",
                "managedByTenantId": "[parameters('managedByTenantId')]",
                "authorizations": "[variables('authorizations')]"
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[guid(format('{0}{1}{2}', variables('mspOfferName'), parameters('managedByTenantId'), parameters('resourceGroupName')))]",
              "resourceGroup": "[parameters('resourceGroupName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "mspRegistrationId": {
                    "value": "[subscriptionResourceId('Microsoft.ManagedServices/registrationDefinitions', guid(format('{0}{1}{2}', variables('mspOfferName'), parameters('managedByTenantId'), parameters('resourceGroupName'))))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "1204641134268571702"
                    }
                  },
                  "parameters": {
                    "mspRegistrationId": {
                      "type": "string",
                      "metadata": {
                        "description": "The registration ID to assign"
                      }
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.ManagedServices/registrationAssignments",
                      "apiVersion": "2022-10-01",
                      "name": "[parameters('mspRegistrationId')]",
                      "properties": {
                        "registrationDefinitionId": "[parameters('mspRegistrationId')]"
                      }
                    }
                  ],
                  "outputs": {
                    "assignment": {
                      "type": "object",
                      "value": "[reference(resourceId('Microsoft.ManagedServices/registrationAssignments', parameters('mspRegistrationId')), '2022-10-01', 'full')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.ManagedServices/registrationDefinitions', guid(format('{0}{1}{2}', variables('mspOfferName'), parameters('managedByTenantId'), parameters('resourceGroupName'))))]"
              ]
            }
          ]
        }
      }
    }
  ],
  "outputs": {
    "mspOfferName": {
      "type": "string",
      "value": "[format('Managed by {0}', variables('mspOfferName'))]"
    },
    "authorizations": {
      "type": "array",
      "value": "[variables('authorizations')]"
    }
  }
}